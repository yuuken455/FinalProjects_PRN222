@page
@model RazorPage.Pages.Manager.IndexModel
@{
    Layout = "_ManagerLayout";
    ViewData["Title"] = "Bảng điều khiển";
}
<div class="manager-dashboard">
    <h1 class="h3 mb-4"><i class="bi bi-speedometer2 me-2"></i>Dashboard</h1>

    <!-- KPI Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3"><div class="card shadow-sm p-3"><div><b>Lịch hẹn hôm nay:</b> @Model.Data.TodayAppointments</div></div></div>
        <div class="col-md-3"><div class="card shadow-sm p-3"><div><b>Tồn kho thấp:</b> @Model.Data.LowStockParts</div></div></div>
        <div class="col-md-3"><div class="card shadow-sm p-3"><div><b>Khách hàng hoạt động:</b> @Model.Data.ActiveCustomers</div></div></div>
        <div class="col-md-3"><div class="card shadow-sm p-3"><div><b>Doanh thu tháng:</b> @Model.Data.MonthlyRevenue.ToString("N0") đ</div></div></div>
    </div>

    <!-- Charts -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card shadow-sm p-3">
                <h5>Doanh thu theo tháng</h5>
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm p-3">
                <h5>Trạng thái lịch hẹn</h5>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const revenueCtx = document.getElementById('revenueChart');
        new Chart(revenueCtx, {
            type: 'bar',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Data.Months)),
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Data.Revenues)),
                    backgroundColor: '#4e73df'
                }]
            }
        });

        const statusCtx = document.getElementById('statusChart');
        new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Data.AppointmentStatus.Keys)),
                datasets: [{
                    data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Data.AppointmentStatus.Values)),
                    backgroundColor: ['#36b9cc','#f6c23e','#1cc88a','#e74a3b']
                }]
            }
        });

        // SignalR cập nhật realtime
        const conn = new signalR.HubConnectionBuilder().withUrl("/hubs/notify").build();
        conn.on("DashboardUpdated", () => location.reload());
        conn.start();
    </script>
}